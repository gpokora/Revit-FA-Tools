<dx:ThemedWindow x:Class="Revit_FA_Tools.Views.Addressing.DeviceAddressingWindow"
                xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                xmlns:dx="http://schemas.devexpress.com/winfx/2008/xaml/core"
                xmlns:dxg="http://schemas.devexpress.com/winfx/2008/xaml/grid"
                xmlns:dxe="http://schemas.devexpress.com/winfx/2008/xaml/editors"
                xmlns:dxr="http://schemas.devexpress.com/winfx/2008/xaml/ribbon"
                xmlns:dxb="http://schemas.devexpress.com/winfx/2008/xaml/bars"
                xmlns:dxdo="http://schemas.devexpress.com/winfx/2008/xaml/docking"
                Title="Device Addressing Tool" 
                Height="900" Width="1400"
                WindowStartupLocation="CenterOwner">
    
    <dx:ThemedWindow.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
    </dx:ThemedWindow.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- Ribbon -->
            <RowDefinition Height="*"/>     <!-- Main Content -->
            <RowDefinition Height="Auto"/>  <!-- Status Bar -->
        </Grid.RowDefinitions>
        
        <!-- Ribbon Toolbar -->
        <dxr:RibbonControl Grid.Row="0" RibbonStyle="Office2019">
            <dxr:RibbonPage Caption="Operations">
                <dxr:RibbonPageGroup Caption="History">
                    <dxb:BarButtonItem Content="Undo" 
                                      LargeGlyph="{dx:DXImage SvgImages/Actions/Undo_32x32.png}"
                                      Command="{Binding UndoCommand}"/>
                    <dxb:BarButtonItem Content="Redo" 
                                      LargeGlyph="{dx:DXImage SvgImages/Actions/Redo_32x32.png}"
                                      Command="{Binding RedoCommand}"/>
                </dxr:RibbonPageGroup>
                <dxr:RibbonPageGroup Caption="Assignment">
                    <dxb:BarButtonItem Content="Auto Assign" 
                                      LargeGlyph="{dx:DXImage SvgImages/Actions/Apply_32x32.png}"
                                      Command="{Binding AutoAssignCommand}"/>
                    <dxb:BarButtonItem Content="Clear All" 
                                      LargeGlyph="{dx:DXImage SvgImages/Actions/Cancel_32x32.png}"
                                      Command="{Binding ClearAllCommand}"/>
                </dxr:RibbonPageGroup>
                <dxr:RibbonPageGroup Caption="State">
                    <dxb:BarButtonItem Content="Save State" 
                                      LargeGlyph="{dx:DXImage SvgImages/Save/Save_32x32.png}"
                                      Command="{Binding SaveStateCommand}"/>
                    <dxb:BarButtonItem Content="Load State" 
                                      LargeGlyph="{dx:DXImage SvgImages/Actions/Open_32x32.png}"
                                      Command="{Binding LoadStateCommand}"/>
                </dxr:RibbonPageGroup>
            </dxr:RibbonPage>
        </dxr:RibbonControl>
        
        <!-- Main Content using DockLayoutManager -->
        <dxdo:DockLayoutManager Grid.Row="1">
            
            <!-- System Tree Panel (Left) -->
            <dxdo:LayoutGroup Orientation="Horizontal">
                <dxdo:LayoutPanel Caption="System Tree" ItemWidth="2*">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Search and Filters -->
                        <StackPanel Grid.Row="0" Margin="8" Orientation="Horizontal">
                            <dxe:TextEdit Text="{Binding TreeSearchText, UpdateSourceTrigger=PropertyChanged}"
                                        NullText="Search system tree..."
                                        Width="200" Margin="0,0,8,0" />
                            <dxe:ComboBoxEdit EditValue="{Binding TreeFilter}" 
                                            Width="120" Margin="0,0,8,0">
                                <dxe:ComboBoxEditItem Content="All Devices"/>
                                <dxe:ComboBoxEditItem Content="Addressed Only"/>
                                <dxe:ComboBoxEditItem Content="Unaddressed Only"/>
                                <dxe:ComboBoxEditItem Content="Conflicts Only"/>
                            </dxe:ComboBoxEdit>
                        </StackPanel>
                        
                        <!-- Device Tree -->
                        <dxg:TreeListControl Grid.Row="1" 
                                           Name="DeviceTreeList"
                                           ItemsSource="{Binding SystemTreeItems}"
                                           AllowDrop="True"
                                           Drop="OnTreeDrop" 
                                           DragOver="OnTreeDragOver" 
                                           MouseMove="OnTreeMouseMove">
                            
                            <dxg:TreeListControl.Columns>
                                <dxg:TreeListColumn FieldName="DisplayText" Header="Device" Width="*"/>
                                <dxg:TreeListColumn FieldName="AssignedAddress" Header="Address" Width="80">
                                    <dxg:TreeListColumn.EditSettings>
                                        <dxe:SpinEditSettings MinValue="1" MaxValue="159" 
                                                            AllowDefaultButton="False"/>
                                    </dxg:TreeListColumn.EditSettings>
                                </dxg:TreeListColumn>
                                <dxg:TreeListColumn FieldName="IsAddressLocked" Header="ðŸ”’" Width="40"/>
                                <dxg:TreeListColumn FieldName="CurrentDraw" Header="Current (A)" Width="80"/>
                                <dxg:TreeListColumn FieldName="PowerConsumption" Header="Power (W)" Width="80"/>
                            </dxg:TreeListControl.Columns>
                            
                            <dxg:TreeListControl.View>
                                <dxg:TreeListView AutoWidth="True" 
                                                ShowAutoFilterRow="True"
                                                AllowEditing="True"
                                                CellValueChanged="OnAddressChanged"/>
                            </dxg:TreeListControl.View>
                        </dxg:TreeListControl>
                    </Grid>
                </dxdo:LayoutPanel>
                
                <!-- Available Devices Panel (Right) -->
                <dxdo:LayoutPanel Caption="Available Devices" ItemWidth="1*">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        
                        <!-- Device Pool Search -->
                        <StackPanel Grid.Row="0" Margin="8" Orientation="Horizontal">
                            <dxe:TextEdit Text="{Binding DevicePoolSearchText, UpdateSourceTrigger=PropertyChanged}"
                                        NullText="Search available devices..."
                                        Width="200" Margin="0,0,8,0" />
                        </StackPanel>
                        
                        <!-- Available Devices Grid -->
                        <dxg:GridControl Grid.Row="1" 
                                       ItemsSource="{Binding AvailableDevices}">
                            
                            <dxg:GridControl.Columns>
                                <dxg:GridColumn FieldName="DeviceName" Header="Device" Width="*"/>
                                <dxg:GridColumn FieldName="DeviceType" Header="Type" Width="100"/>
                                <dxg:GridColumn FieldName="Level" Header="Level" Width="80"/>
                                <dxg:GridColumn FieldName="CurrentDraw" Header="Current" Width="70"/>
                                <dxg:GridColumn FieldName="PowerConsumption" Header="Power" Width="70"/>
                            </dxg:GridControl.Columns>
                            
                            <dxg:GridControl.View>
                                <dxg:TableView AutoWidth="True" 
                                             ShowAutoFilterRow="True"
                                             AllowGrouping="True"
                                             ShowGroupPanel="True"/>
                            </dxg:GridControl.View>
                        </dxg:GridControl>
                        
                        <!-- Address Pool Status -->
                        <Border Grid.Row="2" Background="LightGray" Padding="8">
                            <StackPanel>
                                <TextBlock Text="{Binding AddressUtilizationText}" FontWeight="Bold"/>
                                <ProgressBar Value="{Binding AddressUtilizationPercentage}" 
                                           Maximum="100" Height="8" Margin="0,4,0,0"/>
                                <TextBlock Text="{Binding CapacityWarningText}" 
                                         Foreground="Red" 
                                         Visibility="{Binding HasCapacityWarning, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </dxdo:LayoutPanel>
            </dxdo:LayoutGroup>
        </dxdo:DockLayoutManager>
        
        <!-- Status Bar -->
        <StatusBar Grid.Row="2">
            <StatusBarItem Content="{Binding StatusMessage}"/>
            <Separator/>
            <StatusBarItem Content="{Binding SelectedDeviceCount}"/>
            <Separator/>
            <StatusBarItem Content="{Binding ValidationStatusText}"/>
            <Separator/>
            <StatusBarItem Content="{Binding LastOperationText}"/>
        </StatusBar>
    </Grid>
</dx:ThemedWindow>