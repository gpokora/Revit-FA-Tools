<dx:ThemedWindow x:Class="Revit_FA_Tools.Views.AddressingPanelWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:dx="http://schemas.devexpress.com/winfx/2008/xaml/core"
        xmlns:dxg="http://schemas.devexpress.com/winfx/2008/xaml/grid"
        xmlns:dxe="http://schemas.devexpress.com/winfx/2008/xaml/editors"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        dx:ThemeManager.ThemeName="Win11Dark"
        Title="Device Addressing Management"
        Height="700" 
        Width="1200" 
        >

    <dx:ThemedWindow.Resources>
        <!-- Converters can be added here if needed -->
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        
        <!-- Styles -->
        <Style x:Key="ConflictTextStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Foreground" Value="Green"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding HasConflicts}" Value="True">
                    <Setter Property="Foreground" Value="Red"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </dx:ThemedWindow.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <ToolBar Grid.Row="0" Height="35">
            <Button Content="Auto Assign (Branch)" Padding="10,3" Margin="5,2" 
                    ToolTip="Sequential assignment respecting locks and manual values" 
                    Command="{Binding AutoAssignCommand}"/>
            <Button Content="Re-sequence (Branch)" Padding="10,3" Margin="5,2" 
                    ToolTip="Compact addresses for Auto devices only" 
                    Command="{Binding ResequenceCommand}"/>
            <Button Content="Gap Fill (Branch)" Padding="10,3" Margin="5,2" 
                    ToolTip="Fill gaps left by removals" 
                    Command="{Binding GapFillCommand}"/>
            <Button Content="First Available (Device)" Padding="10,3" Margin="5,2" 
                    ToolTip="Assign first free slot for selected device" 
                    Command="{Binding FirstAvailableCommand}"
                    CommandParameter="{Binding ElementName=DeviceGrid, Path=SelectedItem}"/>
            <Separator/>
            <Button Content="Validate" Padding="10,3" Margin="5,2" 
                    ToolTip="Check for address conflicts" 
                    Command="{Binding ValidateCommand}"/>
            <Button Content="Resolve Conflicts" Padding="10,3" Margin="5,2" 
                    ToolTip="Auto-resolve conflicts by gap-filling Auto devices" 
                    Command="{Binding ResolveConflictsCommand}"/>
            <Separator/>
            <Button Content="Save to Revit" Padding="10,3" Margin="5,2" 
                    Background="Orange" FontWeight="Bold"
                    ToolTip="Push addresses back to Revit parameters" 
                    Command="{Binding SaveToRevitCommand}"/>
        </ToolBar>

        <!-- Options Panel -->
        <GroupBox Grid.Row="1" Header="Addressing Options" Margin="10,5" Height="80" VerticalAlignment="Top">
            <StackPanel Orientation="Horizontal" Margin="10">
                <Label Content="Start Address:" VerticalAlignment="Center"/>
                <dxe:SpinEdit Value="{Binding StartAddress, Mode=TwoWay}" MinValue="1" MaxValue="999" Width="60" Margin="5,0"/>
                <CheckBox Content="Preserve Manual" IsChecked="{Binding PreserveManual, Mode=TwoWay}" Margin="15,0,0,0" 
                          ToolTip="Do not overwrite user-entered values"/>
                <CheckBox Content="Respect Locks" IsChecked="{Binding RespectLocks, Mode=TwoWay}" Margin="15,0,0,0" 
                          ToolTip="Do not move devices marked Locked"/>
                <CheckBox Content="Gap Fill" IsChecked="{Binding GapFill, Mode=TwoWay}" Margin="15,0,0,0" 
                          ToolTip="Fill gaps left by removals"/>
                <Label Content="Branch:" Margin="30,0,5,0" VerticalAlignment="Center"/>
                <ComboBox ItemsSource="{Binding Branches}" SelectedItem="{Binding SelectedBranch, Mode=TwoWay}" 
                          Width="150" Margin="5,0"/>
            </StackPanel>
        </GroupBox>

        <!-- Device Grid -->
        <dxg:GridControl Name="DeviceGrid" Grid.Row="1" Margin="10,90,10,10" SelectionMode="Row" 
                        ItemsSource="{Binding Devices}">
            <dxg:GridControl.View>
                <dxg:TableView ShowGroupPanel="False" 
                              AllowEditing="True"
                              NavigationStyle="Row"
                              ShowIndicator="True"
                              AutoWidth="True"
                              AllowColumnFiltering="True"
                              AllowSorting="True" 
                              AllowDragDrop="True"
                              ImmediateUpdateRowPosition="True"/>
            </dxg:GridControl.View>

            <dxg:GridControl.Columns>
                <dxg:GridColumn FieldName="ElementId" Header="Element ID" Width="80" AllowEditing="False"/>
                <dxg:GridColumn FieldName="Level" Header="Level" Width="100" AllowEditing="False"/>
                <dxg:GridColumn FieldName="Family" Header="Family" Width="120" AllowEditing="False"/>
                <dxg:GridColumn FieldName="Type" Header="Type" Width="120" AllowEditing="False"/>
                <dxg:GridColumn FieldName="BranchId" Header="Branch" Width="100" AllowEditing="False"/>
                <dxg:GridColumn FieldName="Address" Header="Address" Width="80" AllowEditing="True">
                    <dxg:GridColumn.EditSettings>
                        <dxe:SpinEditSettings MinValue="0" MaxValue="999"/>
                    </dxg:GridColumn.EditSettings>
                </dxg:GridColumn>
                <dxg:GridColumn FieldName="AddressSlots" Header="Slots" Width="60" AllowEditing="True">
                    <dxg:GridColumn.EditSettings>
                        <dxe:SpinEditSettings MinValue="1" MaxValue="4"/>
                    </dxg:GridColumn.EditSettings>
                </dxg:GridColumn>
                <dxg:GridColumn FieldName="LockState" Header="Lock State" Width="80" AllowEditing="True">
                    <dxg:GridColumn.EditSettings>
                        <dxe:ComboBoxEditSettings>
                            <dxe:ComboBoxEditSettings.Items>
                                <sys:String>Auto</sys:String>
                                <sys:String>Locked</sys:String>
                            </dxe:ComboBoxEditSettings.Items>
                        </dxe:ComboBoxEditSettings>
                    </dxg:GridColumn.EditSettings>
                </dxg:GridColumn>
                <dxg:GridColumn FieldName="StatusDescription" Header="Status" Width="150" AllowEditing="False"/>
                <dxg:GridColumn FieldName="ValidationMessage" Header="Issues" Width="200" AllowEditing="False"/>
            </dxg:GridControl.Columns>
        </dxg:GridControl>

        <!-- Status Panel -->
        <GroupBox Grid.Row="2" Header="Address Summary" Margin="10,5" Height="80">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Margin="10">
                    <Label Content="Address Range:" FontWeight="Bold"/>
                    <TextBlock Text="{Binding AddressRange}" FontSize="14"/>
                </StackPanel>

                <StackPanel Grid.Column="1" Margin="10">
                    <Label Content="Total Devices:" FontWeight="Bold"/>
                    <TextBlock Text="{Binding TotalDevices}" FontSize="14"/>
                </StackPanel>

                <StackPanel Grid.Column="2" Margin="10">
                    <Label Content="Locked Devices:" FontWeight="Bold"/>
                    <TextBlock Text="{Binding LockedDevices}" FontSize="14"/>
                </StackPanel>

                <StackPanel Grid.Column="3" Margin="10">
                    <Label Content="Conflicts:" FontWeight="Bold"/>
                    <TextBlock Text="{Binding Conflicts}" Style="{StaticResource ConflictTextStyle}"/>
                </StackPanel>
            </Grid>
        </GroupBox>

        <!-- Close Button -->
        <Button Grid.Row="3" Content="Close" Width="80" Height="30" 
                HorizontalAlignment="Right" Margin="10" 
                Click="Close_Click"/>
    </Grid>
</dx:ThemedWindow>